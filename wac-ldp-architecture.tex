\documentclass[10pt]{article}
\usepackage[utf8]{inputenc}

% Page setup
\usepackage[a3paper,landscape,margin=2cm]{geometry}

% Typography
\usepackage[T1]{fontenc}
\usepackage[scaled]{berasans}
\usepackage[scaled]{beramono}
\renewcommand*\familydefault{\sfdefault}
\usepackage{microtype}
\parindent 0pt

% TikZ
\usepackage{./tikz-uml}
\usetikzlibrary{positioning}

% Headings
\makeatletter
\def\@maketitle{%
  {\LARGE\bf\@title\par}
  \vskip .5em
  {\large\@author\ -- \@date\par}
  \vskip 2em
}
\makeatother

% Notes
\usepackage{multicol}
\newenvironment{Note}
  {\begin{multicols}{3}%
     \parskip 1em}
  {\end{multicols}}

% Document metadata
\title{
  wac-ldp architecture
  \it (status: draft)
}
\author{Michiel de Jong, Aaron Coburn}

\begin{document}

\maketitle


\section*{Purpose}
This document describes the code structure of inrupt's wac-ldp component.


\section*{Legend}
The architectural diagram follows standard UML notation.

For more specific symbols that are not part of UML,
Node.js/JavaScript/TypeScript conventions were used as follows:

\begin{description}
  \item[T?] represents a~value that is either not present
            or a~value of type~T.
  \item[Promise<T>] represents a~value that will asynchronously resolve
                    to a~value of type~T.
  \item[Readable<T>] represents an asynchronous one-time readable stream
                     of values of type~T.
  \item[Buffer] is an in-memory buffer of bytes,
                possibly with a~character encoding.
\end{description}


\newcommand\ResourceStoreBody{%
  + getRepresentation(ResourceIdentifier, RepresentationPreferences) : Promise<Representation>\\
  + addResource(container : ResourceIdentifier, Representation) : Promise<ResourceIdentifier>\\
  + setRepresentation(ResourceIdentifier, Representation) : Promise<void>\\
  + deleteResource(ResourceIdentifier) : Promise<void>\\
  + modifyResource(ResourceIdentifier, Patch) : Promise<void>\\
}

\section*{Diagram}
\begin{tikzpicture}

\begin{umlpackage}{HTTP}
  \umlinterface[]{HttpHandler}{}{
    + canHandle(HttpRequest) : Promise<boolean>\\
    + handle(HttpRequest, HttpResponse) : void\\
  }

  \umlclass[right=1 of HttpHandler]{HttpServer}{}{
    + HttpServer(Array<HttpHandler>)\\
    + listen(port : int) : void\\
    + handle(HttpRequest, HttpResponse) : void\\
  }
  \umluniaggreg[mult=*]{HttpServer}{HttpHandler}
\end{umlpackage}

\begin{umlpackage}[y=-4.5]{LDP}
  \umlclass{LdpHandler}{}{
    + LdpHandler(OperationFactory)\\
  }
  \umlimpl{LdpHandler}{HttpHandler}


  \umlsimpleclass[right=2 of LdpHandler.north east,anchor=south west]{TargetExtractor}
  \umluniaggreg[mult=1,anchor2=west]{LdpHandler}{TargetExtractor}

  \umlsimpleclass[right=2 of TargetExtractor]{ResourceIdentifier}
  \umldep[arg=creates,pos=0.5]{TargetExtractor}{ResourceIdentifier}


  \umlsimpleclass[below=0.25 of TargetExtractor.south east,anchor=north east]{BodyParser}
  \umluniaggreg[mult=*,anchor2=west]{LdpHandler}{BodyParser}

  \umlsimpleclass[below=0.25 of ResourceIdentifier.south west,anchor=north west]{Representation}
  \umldep[arg=creates,pos=0.5]{BodyParser}{Representation}

  \umlsimpleclass[right=1 of Representation]{Patch}
  \umlinherit{Patch}{Representation}


  \umlsimpleclass[below=0.25 of BodyParser.south east,anchor=north east]{PreferenceParser}
  \umluniaggreg[mult=1,anchor2=west]{LdpHandler}{PreferenceParser}

  \umlsimpleclass[below=0.25 of Representation.south west,anchor=north west]{RepresentationPreferences}
  \umldep[arg=creates,pos=0.5]{PreferenceParser}{RepresentationPreferences}


  \umlsimpleclass[below=0.25 of PreferenceParser.south east,anchor=north east]{ResponseWriter}
  \umluniaggreg[mult=1,anchor1=south east,anchor2=west]{LdpHandler}{ResponseWriter}

  \umlsimpleclass[below=0.25 of RepresentationPreferences.south west,anchor=north west]{HttpResponse}
  \umldep[arg=writes,pos=0.5]{ResponseWriter}{HttpResponse}


  \begin{umlpackage}[x=6,y=-4]{Operations}
    \umlclass[]{OperationFactory}{}{
      + OperationFactory(ResourceStore)\\
      + createOperation(method : string, ResourceIdentifier,\\*
                        RepresentationPreferences, \ldots) : Operation\\
    }
    \umluniaggreg[mult=1,geometry=|-]{LdpHandler}{OperationFactory}

    \umlinterface[below=1 of OperationFactory]{Operation}{
      + target : ResourceIdentifier\\
      + requestBody : Representation?\\
      + preferences : RepresentationPreferences\\
      + requiredPermissions : PermissionSet\\
    }{
      + execute() : Promise<ResponseDescription>\\
    }
    \umldep[arg=creates,pos=0.5]{OperationFactory}{Operation}

    \umlsimpleclass[right=1 of Operation.north east,anchor=north west]{GetOperation}
    \umlsimpleclass[below=.25 of GetOperation.south west,anchor=north west]{PostOperation}
    \umlsimpleclass[below=.25 of PostOperation.south west,anchor=north west]{PutOperation}
    \umlsimpleclass[below=.25 of PutOperation.south west,anchor=north west]{PatchOperation}
    \umlimpl[anchor1=west]{GetOperation}{Operation}
    \umlimpl[anchor1=west]{PostOperation}{Operation}
    \umlimpl[anchor1=west]{PutOperation}{Operation}
    \umlimpl[anchor1=west]{PatchOperation}{Operation}

  \end{umlpackage}
\end{umlpackage}

\begin{umlpackage}{Storage}
  \umlinterface[below=2.25 of Operation]{ResourceStore}{}{
    \ResourceStoreBody
  }
  \umluniaggreg[mult=1]{Operation}{ResourceStore}
\end{umlpackage}

\end{document}
